<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tabligh Akbar & Multi Agenda Muhammadiyah Siak ‚Äî Pimpinan Daerah Muhammadiyah Siak</title>
  <meta name="description" content="Program infaq dan sodaqoh ini berjalan berkelanjutan." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --accent: #22c55e; }
    .accent { color: var(--accent); }
    .bg-accent { background: var(--accent); }
    .ring-accent { --tw-ring-color: var(--accent); }
    .gradient {
      background: radial-gradient(80% 80% at 50% 20%, rgba(16,185,129,.20), transparent),
                  conic-gradient(from 180deg at 50% 50%, rgba(16,185,129,.15), transparent);
    }
  </style>
</head>
<body class="min-h-screen bg-gray-950 text-gray-100">
  <div class="absolute inset-0 -z-10 gradient"></div>

  <header class="max-w-5xl mx-auto px-4 py-8">
    <div class="flex items-center gap-4">
      <div class="w-16 h-26 rounded-full bg-accent/20 ring-1 ring-accent grid place-items-center overflow-hidden">
        <img src="ssh1.png" alt="" class="w-full h-full object-cover">
      </div>
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Tabligh Akbar & Multi Agenda Muhammadiyah Siak</h1>
        <p class="text-gray-400"><span class="font-medium text-white">Pimpinan Daerah Muhammadiyah Siak</span></p>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-16">
    <section class="grid md:grid-cols-3 gap-6">
      <!-- Kiri: Info Program + Progress -->
      <div class="md:col-span-2 p-6 rounded-2xl bg-gray-900/60 ring-1 ring-white/10">
        <h2 class="text-xl font-semibold mb-2">Program infaq dan sodaqoh</h2>
        <p class="text-gray-300 mb-6">Programan Infaq dan sodaqoh ini berjalan berkelanjutan.</p>

        <!-- Progress -->
        <div class="p-4 rounded-xl bg-black/30 ring-1 ring-white/10 mb-6">
          <div class="flex items-end justify-between gap-4 mb-3">
            <div>
              <p class="text-sm text-gray-400">Terkumpul</p>
              <p class="text-2xl font-semibold">
                <span id="totalAmount">Rp 0</span>
                <span class="text-sm text-gray-400 font-normal">/ Rp 50.000.000</span>
              </p>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-400">Progres</p>
              <p class="text-2xl font-semibold"><span id="progressPercent">0</span>%</p>
            </div>
          </div>
          <div class="h-3 w-full rounded-full bg-white/10 overflow-hidden">
            <div id="progressBar" class="h-full bg-accent" style="width:0%"></div>
          </div>
        </div>

        <!-- Aksi -->
        <div class="grid sm:grid-cols-2 gap-4">
          <button id="openDonate" class="px-4 py-3 rounded-xl bg-accent text-black font-semibold ring-1 ring-white/10 hover:opacity-90 transition">
            üíö Donasi Sekarang
          </button>
          <button id="exportCsv" class="px-4 py-3 rounded-xl bg-white/10 text-white font-semibold ring-1 ring-white/10 hover:bg-white/20 transition">
            ‚¨áÔ∏è Export CSV Donatur
          </button>
        </div>
      </div>

      <!-- Kanan: Metode Pembayaran -->
      <aside class="p-6 rounded-2xl bg-gray-900/60 ring-1 ring-white/10">
        <h3 class="text-lg font-semibold mb-3">Metode Pembayaran</h3>

        <div class="space-y-4">
          <!-- DANA -->
          <div class="p-4 rounded-xl bg-black/30 ring-1 ring-white/10">
            <p class="text-sm text-gray-400">DANA (Putra Baruta)</p>
            <p class="text-xl font-semibold tracking-wide select-all text-white" id="danaNumber">082376599674</p>
            <div class="mt-3 flex items-center gap-2">
              <button class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm transition" onclick="copyToClipboard('danaNumber')">Copy</button>
              <a class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm transition"
                 target="_blank" rel="noreferrer"
                 href="https://api.qrserver.com/v1/create-qr-code/?size=512x512&data=082376599674">Lihat QR</a>
            </div>
          </div>

          <!-- BRK -->
          <div class="p-4 rounded-xl bg-black/30 ring-1 ring-white/10">
            <p class="text-sm text-gray-400">BRK (LAZIZMU SIAK)</p>
            <p class="text-xl font-semibold tracking-wide select-all text-white" id="brkNumber">820-31-58786</p>
            <div class="mt-3 flex items-center gap-2">
              <button class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm transition" onclick="copyToClipboard('brkNumber')">Copy</button>
              <a class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm transition"
                 target="_blank" rel="noreferrer"
                 href="https://api.qrserver.com/v1/create-qr-code/?size=512x512&data=820-31-58786">Lihat QR</a>
            </div>
          </div>

          <!-- Mandiri Syariah -->
          <div class="p-4 rounded-xl bg-black/30 ring-1 ring-white/10">
            <p class="text-sm text-gray-400">BANK SYARIAH INDONESIA (LAZIZMU SIAK)</p>
            <p class="text-xl font-semibold tracking-wide select-all text-white" id="mandiriNumber">7440070706</p>
            <div class="mt-3 flex items-center gap-2">
              <button class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm transition" onclick="copyToClipboard('mandiriNumber')">Copy</button>
              <a class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm transition"
                 target="_blank" rel="noreferrer"
                 href="https://api.qrserver.com/v1/create-qr-code/?size=512x512&data=7440070706">Lihat QR</a>
            </div>
          </div>

          <!-- Catatan -->
          <div class="p-4 rounded-xl bg-black/30 ring-1 ring-white/10">
            <p class="text-sm text-gray-400">Catatan</p>
            <p class="text-sm text-gray-300">
              Setelah transfer, silakan isi form donasi agar nama & nominal tercatat di daftar donatur.
              Verifikasi otomatis tidak tersedia.
            </p>
          </div>
        </div>
      </aside>
    </section>

    <!-- Donatur Terbaru -->
    <section class="mt-8 p-6 rounded-2xl bg-gray-900/60 ring-1 ring-white/10">
      <h3 class="text-lg font-semibold mb-4">Donatur Terbaru</h3>
      <ul id="donorList" class="space-y-3"></ul>
    </section>
  </main>

  <!-- Modal Donasi -->
  <div id="donateModal" class="fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="absolute inset-0 bg-black/70" onclick="closeModal()"></div>
    <div class="relative w-full max-w-lg rounded-2xl bg-gray-900 text-white p-6 ring-1 ring-white/20">
      <h3 class="text-xl font-semibold mb-4">Isi Form Donasi</h3>
      <form id="donasiForm" class="space-y-4">
        <input id="nama" type="text" placeholder="Nama Anda" required
          class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:ring-2 focus:ring-emerald-500 outline-none">
        <input id="nominal" type="number" placeholder="Nominal (Rp)" min="1000" required
          class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:ring-2 focus:ring-emerald-500 outline-none">
        <textarea id="pesan" placeholder="Pesan (Opsional)" rows="2"
          class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 focus:ring-2 focus:ring-emerald-500 outline-none"></textarea>

        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Batal</button>
          <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 font-semibold">üíö Simpan Donasi</button>
        </div>
      </form>
    </div>
  </div>

  <footer class="text-center text-gray-500 text-sm py-10">
    ¬© <span id="year"></span> Wakaf Platform ‚Äî Pimpinan Daerah Muhammadiyah Siak
  </footer>

  <!-- Script util -->
  <script>
    function copyToClipboard(elementId) {
      const text = document.getElementById(elementId).innerText.trim();
      navigator.clipboard.writeText(text).then(() => {
        alert("Nomor berhasil disalin: " + text);
      });
    }

    document.getElementById('year').textContent = new Date().getFullYear();
  </script>

  <!-- Firebase + Firestore Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
    apiKey: "AIzaSyBhlcDzgkQIRnZffXnZXgqjJLiGAtbhLTQ",
    authDomain: "evaluasikkn.firebaseapp.com",
    projectId: "evaluasikkn",
    storageBucket: "evaluasikkn.firebasestorage.app",
    messagingSenderId: "383924662886",
    appId: "1:383924662886:web:b47fc3a7f7ee570322f3a7",
    measurementId: "G-628SFPQ3NH"
    }

    const app = initializeApp(firebaseConfig)
    const db = getFirestore(app)
    const messagesRef = collection(db, 'messages')

    const GOAL = 50000000;

    const modal = document.getElementById("donateModal");
    const openBtn = document.getElementById("openDonate");
    const form = document.getElementById("donasiForm");
    const donorList = document.getElementById("donorList");
    const totalAmountEl = document.getElementById("totalAmount");
    const progressPercentEl = document.getElementById("progressPercent");
    const progressBarEl = document.getElementById("progressBar");
    const exportBtn = document.getElementById("exportCsv");

    const openModal = () => modal.classList.remove("hidden");
    window.closeModal = () => modal.classList.add("hidden");
    openBtn?.addEventListener("click", openModal);

    // ====== Simpan donasi ke Firestore ======
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nama = document.getElementById("nama").value.trim() || "Hamba Allah";
      const nominal = parseInt(document.getElementById("nominal").value, 10) || 0;
      const pesan = document.getElementById("pesan").value.trim();

      if (nominal <= 0) {
        alert("Nominal tidak valid.");
        return;
      }

      try {
        await addDoc(collection(db, "donatur"), {
          nama,
          nominal,
          pesan,
          ts: Date.now()
        });
        alert("Donasi berhasil dicatat. Terima kasih! üåø");
        form.reset();
        closeModal();
      } catch (err) {
        console.error(err);
        alert("Gagal menyimpan donasi. Periksa koneksi atau konfigurasi Firebase.");
      }
    });

    // ====== Ambil realtime data donatur ======
    let cachedDonors = [];
    const q = query(collection(db, "donatur"), orderBy("ts", "desc"));
    onSnapshot(q, (snapshot) => {
      const arr = [];
      snapshot.forEach((doc) => arr.push(doc.data()));
      cachedDonors = arr;

      donorList.innerHTML = arr.slice(0, 50).map((d) => {
        const rupiah = (d.nominal||0).toLocaleString('id-ID');
        const waktu = d.ts ? new Date(d.ts + (7*60*60*1000)) : null;
        const waktuStr = waktu ? waktu.toLocaleString('id-ID', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' }) + ' WIB' : '';
        return `
          <li class="flex items-start justify-between gap-4 p-3 rounded-xl bg-black/30 ring-1 ring-white/10">
            <div>
              <p class="font-medium">${escapeHtml(d.nama || 'Hamba Allah')}</p>
              ${d.pesan ? `<p class="text-sm text-gray-400">"${escapeHtml(d.pesan)}"</p>` : ''}
            </div>
            <div class="text-right">
              <p class="font-semibold">Rp ${rupiah}</p>
              ${waktuStr ? `<p class="text-xs text-gray-500">${waktuStr}</p>` : ''}
            </div>
          </li>
        `;
      }).join("");

      const total = arr.reduce((s, x) => s + (parseInt(x.nominal,10)||0), 0);
      totalAmountEl.textContent = 'Rp ' + total.toLocaleString('id-ID');
      const percent = GOAL > 0 ? Math.min(100, Math.round((total/GOAL)*100)) : 0;
      progressPercentEl.textContent = percent;
      progressBarEl.style.width = percent + '%';
    });

    // ====== Export CSV ======
    exportBtn.addEventListener("click", () => {
      if (!cachedDonors.length) {
        alert("Belum ada data donatur.");
        return;
      }
      const header = ["No","Nama","Nominal","Pesan","Waktu (WIB)"];
      const rows = cachedDonors.map((d,i) => {
        const waktu = d.ts ? new Date(d.ts + (7*60*60*1000)).toISOString().replace('T',' ').slice(0,16) : '';
        return [ i+1, (d.nama||''), d.nominal||0, (d.pesan||''), waktu ];
      });
      const csv = [header].concat(rows).map(r => r.map(csvEscape).join(",")).join("\n");
      const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "donations.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Utils
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'
      }[m]));
    }
    function csvEscape(v){
      const s = String(v ?? "");
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }
  </script>
</body>
</html>
